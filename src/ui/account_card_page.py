#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Account Card Page - Modern card-based account management interface
"""

from PyQt5.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton, 
    QFrame, QScrollArea, QGridLayout, QGroupBox, QLineEdit,
    QMessageBox, QProgressBar, QTableWidget, QTableWidgetItem,
    QHeaderView, QStackedWidget, QButtonGroup, QCheckBox,
    QComboBox, QMenu, QAction, QFileDialog, QDialog,
    QDialogButtonBox, QFormLayout, QSpinBox
)
from PyQt5.QtCore import Qt, QTimer, pyqtSignal, QThread
from PyQt5.QtGui import QFont, QPalette, QColor
from src.config.languages import _
from src.ui.theme_manager import theme_manager
import json
from datetime import datetime


class AccountCard(QFrame):
    """Individual account card widget"""
    
    action_requested = pyqtSignal(str, dict)  # action_type, account_data
    
    def __init__(self, account_data, parent=None):
        super().__init__(parent)
        self.account_data = account_data
        self.init_ui()
    
    def init_ui(self):
        """Initialize card UI"""
        self.setObjectName("accountCard")
        self.setFrameStyle(QFrame.Box)
        self.setStyleSheet("""
            QFrame#accountCard {
                background-color: #ffffff;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
                padding: 20px;
            }
            QFrame#accountCard:hover {
                border: 1px solid #007AFF;
                box-shadow: 0 4px 12px rgba(0, 122, 255, 0.15);
            }
        """)
        
        # Main layout
        layout = QVBoxLayout()
        layout.setSpacing(16)
        
        # Header section with status indicator
        header_layout = QHBoxLayout()
        
        # Status icon
        status_icon = self.get_status_icon()
        status_label = QLabel(status_icon)
        status_label.setFont(QFont("Segoe UI Emoji", 24))
        status_label.setStyleSheet("background: transparent; border: none; outline: none; border-radius: 8px; padding: 6px;")
        header_layout.addWidget(status_label)
        
        # Account type badge
        type_badge = QLabel(self.account_data.get('type', 'Trial Pro'))
        type_badge.setStyleSheet("""
            QLabel {
                background-color: #007AFF;
                color: white;
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: bold;
                border: none;
                outline: none;
            }
        """)
        header_layout.addWidget(type_badge)
        
        header_layout.addStretch()
        
        # Status text
        status_text = QLabel(self.get_status_text())
        status_text.setStyleSheet(f"color: {self.get_status_color()}; font-weight: bold; background: transparent; border: none; outline: none; border-radius: 6px; padding: 4px 8px;")
        header_layout.addWidget(status_text)
        
        layout.addLayout(header_layout)
        
        # Divider
        divider = QFrame()
        divider.setFrameShape(QFrame.HLine)
        divider.setStyleSheet("background-color: #f0f0f0;")
        layout.addWidget(divider)
        
        # Account info section
        info_group = QGroupBox("üìß Ë¥¶Êà∑‰ø°ÊÅØ")
        info_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                color: #1a1a1a;
                border: none;
                margin-top: 8px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 0px;
            }
        """)
        info_layout = QVBoxLayout()
        
        # Email
        email_layout = QHBoxLayout()
        email_label = QLabel("ÈÇÆÁÆ±Âú∞ÂùÄ:")
        email_label.setStyleSheet(f"color: {theme_manager.get_color('text_secondary')}; background: transparent; border: none; outline: none; border-radius: 6px; padding: 4px 8px;")
        email_value = QLabel(self.account_data.get('email', 'unknown@email.com'))
        email_value.setStyleSheet(f"color: {theme_manager.get_color('accent_blue')}; font-family: monospace; background: transparent; border: none; outline: none; border-radius: 6px; padding: 4px 8px;")
        email_value.setTextInteractionFlags(Qt.TextSelectableByMouse)
        email_layout.addWidget(email_label)
        email_layout.addWidget(email_value)
        email_layout.addStretch()
        info_layout.addLayout(email_layout)
        
        # User ID
        id_layout = QHBoxLayout()
        id_label = QLabel("Áî®Êà∑ID:")
        id_label.setStyleSheet(f"color: {theme_manager.get_color('text_secondary')}; background: transparent; border: none; outline: none; border-radius: 6px; padding: 4px 8px;")
        id_value = QLabel(self.account_data.get('user_id', 'N/A')[:20] + "...")
        id_value.setStyleSheet(f"color: {theme_manager.get_color('text_primary')}; font-family: monospace; background: transparent; border: none; outline: none; border-radius: 6px; padding: 4px 8px;")
        id_value.setToolTip(self.account_data.get('user_id', 'N/A'))
        id_layout.addWidget(id_label)
        id_layout.addWidget(id_value)
        id_layout.addStretch()
        info_layout.addLayout(id_layout)
        
        info_group.setLayout(info_layout)
        layout.addWidget(info_group)
        
        # Usage info section
        usage_group = QGroupBox("üìä ‰ΩøÁî®ÊÉÖÂÜµ")
        usage_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                color: #1a1a1a;
                border: none;
                margin-top: 8px;
            }
        """)
        usage_layout = QVBoxLayout()
        
        # Usage bar
        usage_bar = QProgressBar()
        usage_value = self.get_usage_percentage()
        usage_bar.setValue(usage_value)
        usage_bar.setStyleSheet("""
            QProgressBar {
                background-color: #f0f0f0;
                border: none;
                border-radius: 8px;
                height: 20px;
                text-align: center;
                color: #1a1a1a;
                font-weight: bold;
            }
            QProgressBar::chunk {
                background-color: """ + self.get_usage_color(usage_value) + """;
                border-radius: 8px;
            }
        """)
        usage_bar.setFormat(f"{self.account_data.get('usage', '0')} / 2500 GB")
        usage_layout.addWidget(usage_bar)
        
        # Expiry date
        expiry_layout = QHBoxLayout()
        expiry_label = QLabel("ËøáÊúüÊó∂Èó¥:")
        expiry_label.setStyleSheet(f"color: {theme_manager.get_color('text_secondary')}; background: transparent; border: none; outline: none; border-radius: 6px; padding: 4px 8px;")
        expiry_value = QLabel(self.format_expiry_date())
        expiry_value.setStyleSheet(f"color: {self.get_expiry_color()}; font-weight: bold; background: transparent; border: none; outline: none; border-radius: 6px; padding: 4px 8px;")
        expiry_layout.addWidget(expiry_label)
        expiry_layout.addWidget(expiry_value)
        expiry_layout.addStretch()
        usage_layout.addLayout(expiry_layout)
        
        usage_group.setLayout(usage_layout)
        layout.addWidget(usage_group)
        
        # Software info section
        software_group = QGroupBox("üîß ËΩØ‰ª∂‰ø°ÊÅØ")
        software_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                color: #1a1a1a;
                border: none;
                margin-top: 8px;
            }
        """)
        software_layout = QVBoxLayout()
        
        # Machine ID
        machine_layout = QHBoxLayout()
        machine_label = QLabel("Êú∫Âô®Á†Å:")
        machine_label.setStyleSheet(f"color: {theme_manager.get_color('text_secondary')}; background: transparent; border: none; outline: none; border-radius: 6px; padding: 4px 8px;")
        machine_value = QLabel(self.account_data.get('machine_id', 'N/A')[:30] + "...")
        machine_value.setStyleSheet(f"color: {theme_manager.get_color('text_secondary')}; font-family: monospace; font-size: 11px; background: transparent; border: none; outline: none; border-radius: 6px; padding: 4px 8px;")
        machine_value.setToolTip(self.account_data.get('machine_id', 'N/A'))
        machine_layout.addWidget(machine_label)
        machine_layout.addWidget(machine_value)
        machine_layout.addStretch()
        software_layout.addLayout(machine_layout)
        
        software_group.setLayout(software_layout)
        layout.addWidget(software_group)
        
        # Action buttons
        button_layout = QHBoxLayout()
        button_layout.setSpacing(12)
        
        # Refresh button
        refresh_btn = QPushButton("üîÑ Âà∑Êñ∞‰ø°ÊÅØ")
        refresh_btn.setObjectName("secondaryButton")
        refresh_btn.setStyleSheet("""
            QPushButton#secondaryButton {
                background-color: #ffffff;
                color: #007AFF;
                border: 1px solid #007AFF;
                border-radius: 8px;
                padding: 8px 16px;
                font-weight: 500;
            }
            QPushButton#secondaryButton:hover {
                background-color: rgba(0, 122, 255, 0.1);
            }
        """)
        refresh_btn.clicked.connect(lambda: self.action_requested.emit("refresh", self.account_data))
        button_layout.addWidget(refresh_btn)
        
        # Primary action button
        if self.is_active():
            action_btn = QPushButton("‚è∏Ô∏è ÂÅúÊ≠¢")
            action_btn.setObjectName("dangerButton")
            action_btn.setStyleSheet("""
                QPushButton#dangerButton {
                    background-color: #FF3B30;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    padding: 8px 16px;
                    font-weight: 500;
                }
                QPushButton#dangerButton:hover {
                    background-color: #D70015;
                }
            """)
            action_btn.clicked.connect(lambda: self.action_requested.emit("stop", self.account_data))
        else:
            action_btn = QPushButton("‚ñ∂Ô∏è ÂêØÂä®")
            action_btn.setObjectName("primaryButton")
            action_btn.setStyleSheet("""
                QPushButton#primaryButton {
                    background-color: #34C759;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    padding: 8px 16px;
                    font-weight: 500;
                }
                QPushButton#primaryButton:hover {
                    background-color: #28A745;
                }
            """)
            action_btn.clicked.connect(lambda: self.action_requested.emit("start", self.account_data))
        
        button_layout.addWidget(action_btn)
        
        layout.addLayout(button_layout)
        
        self.setLayout(layout)
    
    def get_status_icon(self):
        """Get status icon based on account status"""
        status = self.account_data.get('status', 'unknown')
        if status == 'active':
            return "‚úÖ"
        elif status == 'banned':
            return "üö´"
        elif status == 'expired':
            return "‚è∞"
        else:
            return "‚ùì"
    
    def get_status_text(self):
        """Get status text"""
        status = self.account_data.get('status', 'unknown')
        if status == 'active':
            return "Âú®Á∫ø"
        elif status == 'banned':
            return "Â∑≤Â∞ÅÁ¶Å"
        elif status == 'expired':
            return "Â∑≤ËøáÊúü"
        else:
            return "Êú™Áü•"
    
    def get_status_color(self):
        """Get status color"""
        status = self.account_data.get('status', 'unknown')
        if status == 'active':
            return "#34C759"
        elif status == 'banned':
            return "#FF3B30"
        elif status == 'expired':
            return "#FF9500"
        else:
            return "#666666"
    
    def get_usage_percentage(self):
        """Calculate usage percentage"""
        try:
            usage_str = str(self.account_data.get('usage', '0'))
            # Extract numeric value from string like "250 GB" or "250"
            usage_str = usage_str.replace('GB', '').replace('gb', '').strip()
            usage = float(usage_str) if usage_str else 0
            # Assuming 2500 GB is the limit
            percentage = min(100, int((usage / 2500) * 100))
            return percentage
        except:
            return 0
    
    def get_usage_color(self, percentage):
        """Get color based on usage percentage"""
        if percentage < 50:
            return "#34C759"
        elif percentage < 80:
            return "#FF9500"
        else:
            return "#FF3B30"
    
    def format_expiry_date(self):
        """Format expiry date"""
        expiry = self.account_data.get('expiry', '')
        if expiry and expiry != 'N/A':
            expiry_str = str(expiry)
            # If it looks like a date, try to format it
            if '-' in expiry_str or '/' in expiry_str:
                # Just return the date part if it has time
                return expiry_str.split(' ')[0] if ' ' in expiry_str else expiry_str
            return expiry_str
        return "Ê∞∏‰πÖ"  # Permanent
    
    def get_expiry_color(self):
        """Get color based on expiry status"""
        expiry = str(self.account_data.get('expiry', ''))
        
        # Check if already expired
        if self.account_data.get('status') == 'expired':
            return "#FF3B30"  # Red
        
        # Check for days remaining in Chinese format
        if 'Ââ©‰Ωô' in expiry:  # "remaining" in Chinese
            try:
                if 'Â§©' in expiry:  # days
                    days = int(expiry.split('Ââ©‰Ωô')[1].split('Â§©')[0])
                    if days < 7:
                        return "#FF3B30"  # Red
                    elif days < 30:
                        return "#FF9500"  # Orange
                elif 'ÂàÜÈíü' in expiry or 'Â∞èÊó∂' in expiry:  # minutes or hours
                    return "#FF3B30"  # Red for expiring soon
            except:
                pass
        
        return "#666666"  # Default gray
    
    def is_active(self):
        """Check if account is currently active"""
        return self.account_data.get('is_active', False)


class AccountCardPage(QWidget):
    """Main account management page with card layout"""
    
    def __init__(self, account_manager=None, parent=None):
        super().__init__(parent)
        self.account_manager = account_manager
        self.cards = []  # ‰øùÁïôcardsÂ±ûÊÄß‰ª•ÊîØÊåÅÂç°ÁâáËßÜÂõæÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
        self.search_text = ""  # ÊêúÁ¥¢ÊñáÊú¨
        self.selected_accounts = set()  # ÈÄâ‰∏≠ÁöÑË¥¶Êà∑ID
        self.sort_column = 4  # ÈªòËÆ§ÊåâË¥¶Êà∑ËøáÊúüÂàóÔºàÁ¨¨4ÂàóÔºâÊéíÂ∫è
        self.sort_order = Qt.AscendingOrder  # ÈªòËÆ§ÂçáÂ∫è
        self.init_ui()
        self.load_accounts()
    
    def init_ui(self):
        """Initialize the page UI"""
        # Create main container card
        main_container = QFrame()
        main_container.setFrameStyle(QFrame.NoFrame)
        main_container.setStyleSheet("""
            QFrame {
                background: qlineargradient(
                    x1: 0, y1: 0, x2: 1, y2: 1,
                    stop: 0 rgba(255, 255, 255, 0.98),
                    stop: 0.5 rgba(248, 250, 252, 0.95),
                    stop: 1 rgba(241, 245, 249, 0.98)
                );
                border: 1px solid rgba(226, 232, 240, 0.8);
                border-radius: 20px;
                margin: 10px;
            }
        """)
        
        # Container layout
        container_layout = QVBoxLayout(main_container)
        container_layout.setContentsMargins(30, 25, 30, 25)
        container_layout.setSpacing(25)
        
        # Page header (title and description)
        page_header = self.create_page_header()
        container_layout.addWidget(page_header)
        
        # Action buttons header
        action_header = self.create_action_header()
        container_layout.addWidget(action_header)
        
        # Table view - Áõ¥Êé•‰ΩøÁî®Ë°®Ê†ºËßÜÂõæ
        self.create_table_view()
        container_layout.addWidget(self.table_widget)
        
        # Main layout
        main_layout = QVBoxLayout()
        main_layout.setContentsMargins(0, 0, 0, 0)
        main_layout.addWidget(main_container)
        self.setLayout(main_layout)
    
    def create_page_header(self):
        """Create unified page header with title and description"""
        header = QWidget()
        layout = QHBoxLayout()
        layout.setContentsMargins(0, 0, 0, 10)  # ‰∏éhome_page‰∏ÄËá¥
        layout.setSpacing(12)  # ‰∏éhome_page‰∏ÄËá¥
        
        # Left side - Title and description
        left_layout = QVBoxLayout()
        left_layout.setSpacing(4)  # ‰∏éhome_page‰∏ÄËá¥
        
        # Page title - ‰∏éhome_pageÂíåcleanup_pageÁõ∏ÂêåÁöÑÊ†∑Âºè
        title_label = QLabel("üë• Ë¥¶Êà∑ÁÆ°ÁêÜ")
        title_label.setFont(QFont("Segoe UI", 18, QFont.Bold))  # Áªü‰∏ÄÂ≠óÂè∑
        title_label.setStyleSheet(f"color: {theme_manager.get_color('text_primary')}; background: transparent; border: none; outline: none; border-radius: 8px; padding: 6px 12px;")
        title_label.setObjectName("title")  # ËÆæÁΩÆobjectName‰ª•ÊéíÈô§ÂÖ®Â±ÄÊ†∑Âºè
        left_layout.addWidget(title_label)
        
        # Page description - ‰∏éhome_pageÂíåcleanup_pageÁõ∏ÂêåÁöÑÊ†∑Âºè
        desc_label = QLabel("Êü•ÁúãÂíåÁÆ°ÁêÜÂΩìÂâçWarp TerminalË¥¶Êà∑‰ø°ÊÅØ")
        desc_label.setFont(QFont("Segoe UI", 11))  # Áªü‰∏ÄÂ≠óÂè∑
        desc_label.setStyleSheet(f"color: {theme_manager.get_color('text_secondary')}; background: transparent; border: none; outline: none; border-radius: 6px; padding: 4px 8px;")
        desc_label.setObjectName("title")  # ËÆæÁΩÆobjectName‰ª•ÊéíÈô§ÂÖ®Â±ÄÊ†∑Âºè
        left_layout.addWidget(desc_label)
        
        layout.addLayout(left_layout)
        layout.addStretch()
        
        header.setLayout(layout)
        return header
    
    def create_action_header(self):
        """Create action buttons header"""
        header = QWidget()
        layout = QHBoxLayout()
        layout.setContentsMargins(0, 0, 0, 15)
        layout.setSpacing(15)
        
        # Â∑¶ËæπÊåâÈíÆÁªÑ
        # Ê∑ªÂä†Ë¥¶Êà∑ÊåâÈíÆ
        add_btn = QPushButton("‚ûï Ê∑ªÂä†Ë¥¶Êà∑")
        add_btn.setStyleSheet(theme_manager.get_button_style('primary'))
        add_btn.clicked.connect(self.add_account)
        layout.addWidget(add_btn)
        
        # Âà∑Êñ∞ÂÖ®ÈÉ®ÊåâÈíÆ
        refresh_btn = QPushButton("üîÑ Âà∑Êñ∞ÂÖ®ÈÉ®")
        refresh_btn.setStyleSheet(theme_manager.get_button_style('primary'))
        refresh_btn.clicked.connect(self.refresh_all)
        layout.addWidget(refresh_btn)
        
        # ÊâπÈáèÂà†Èô§ÊåâÈíÆ
        batch_delete_btn = QPushButton("üóëÔ∏è ÊâπÈáèÂà†Èô§")
        batch_delete_btn.setStyleSheet(theme_manager.get_button_style('danger_outline'))
        batch_delete_btn.clicked.connect(self.batch_delete)
        layout.addWidget(batch_delete_btn)
        
        # ÂØºÂÖ•ÂØºÂá∫ÊåâÈíÆ
        import_btn = QPushButton("üì• ÂØºÂÖ•")
        import_btn.setStyleSheet(theme_manager.get_button_style('secondary'))
        import_btn.clicked.connect(self.import_accounts)
        layout.addWidget(import_btn)
        
        export_btn = QPushButton("üì§ ÂØºÂá∫")
        export_btn.setStyleSheet(theme_manager.get_button_style('secondary'))
        export_btn.clicked.connect(self.export_accounts)
        layout.addWidget(export_btn)
        
        # ÂàÜÈöîÁ∫ø
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setStyleSheet("background-color: #dee2e6; margin: 0 10px;")
        layout.addWidget(separator)
        
        # ÊâπÈáèÊìç‰ΩúËèúÂçï
        batch_menu_btn = QPushButton("‚ö° ÊâπÈáèÊìç‰Ωú")
        batch_menu_btn.setStyleSheet(theme_manager.get_button_style('warning'))
        batch_menu = QMenu()
        batch_menu.addAction("‚úÖ ÊøÄÊ¥ªÈÄâ‰∏≠", self.batch_activate)
        batch_menu.addAction("‚è∏Ô∏è ÊöÇÂÅúÈÄâ‰∏≠", self.batch_pause)
        batch_menu.addAction("üîÑ Âà∑Êñ∞ÈÄâ‰∏≠", self.batch_refresh_selected)
        batch_menu.addAction("üìã Â§çÂà∂ÈÄâ‰∏≠ÈÇÆÁÆ±", self.copy_selected_emails)
        batch_menu_btn.setMenu(batch_menu)
        layout.addWidget(batch_menu_btn)
        
        layout.addStretch()
        
        # ÊêúÁ¥¢Ê°Ü
        self.search_input = QLineEdit()
        self.search_input.setPlaceholderText("üîç ÊêúÁ¥¢Ë¥¶Âè∑...")
        self.search_input.setStyleSheet("""
            QLineEdit {
                background-color: white;
                border: 1px solid #ced4da;
                border-radius: 6px;
                padding: 8px 12px;
                font-size: 14px;
                min-width: 250px;
            }
            QLineEdit:focus {
                border-color: #007AFF;
                outline: none;
            }
        """)
        self.search_input.textChanged.connect(self.on_search_text_changed)
        layout.addWidget(self.search_input)
        
        # È´òÁ∫ßÁ≠õÈÄâÊåâÈíÆ
        filter_btn = QPushButton("‚öôÔ∏è")
        filter_btn.setToolTip("È´òÁ∫ßÁ≠õÈÄâ")
        filter_btn.setStyleSheet(theme_manager.get_button_style('primary'))
        filter_btn.clicked.connect(self.show_advanced_filter)
        layout.addWidget(filter_btn)
        
        header.setLayout(layout)
        return header
    
    def create_table_view(self):
        """ÂàõÂª∫Ë°®Ê†ºËßÜÂõæ"""
        self.table_widget = QTableWidget()
        self.table_widget.setColumnCount(6)  # ÈÄâÊã©, ÈÇÆÁÆ±, Áä∂ÊÄÅ, ÈôêÂà∂, Ë¥¶Êà∑ËøáÊúü, Êìç‰Ωú
        self.table_widget.setHorizontalHeaderLabels([
            '',  # ÈÄâÊã©Âàó‰∏çÈúÄË¶ÅÊñáÂ≠óÔºåÂè™ÊúâÂ§çÈÄâÊ°Ü
            _('table_email') if hasattr(_, 'table_email') else 'ÈÇÆÁÆ±',
            _('table_status') if hasattr(_, 'table_status') else 'Áä∂ÊÄÅ', 
            _('table_limit') if hasattr(_, 'table_limit') else 'ÈôêÂà∂',
            _('table_expiry') if hasattr(_, 'table_expiry') else 'Ë¥¶Êà∑ËøáÊúü',
            _('table_actions') if hasattr(_, 'table_actions') else 'Êìç‰Ωú'
        ])
        
        # ÂàõÂª∫ÂÖ®ÈÄâÂ§çÈÄâÊ°Ü
        self.select_all_checkbox = QCheckBox()
        self.select_all_checkbox.setToolTip('ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ')
        self.select_all_checkbox.stateChanged.connect(self.toggle_select_all)
        
        # Ë°®Ê†ºÊ†∑Âºè - ÁßªÈô§ÂèØËÉΩÂØºËá¥Ë°®Â§¥Ë¢´Êà™Êñ≠ÁöÑÂõ∫ÂÆöÈ´òÂ∫¶
        self.table_widget.setAlternatingRowColors(True)
        self.table_widget.setStyleSheet("""
            QTableWidget {
                background-color: #ffffff;
                border: 1px solid #e0e0e0;
                border-radius: 10px;
                gridline-color: #f0f0f0;
            }
            QTableWidget::item {
                padding: 8px;
                border: none;
                min-height: 40px;
            }
            QTableWidget::item:selected {
                background-color: rgba(0, 122, 255, 0.1);
                color: #1a1a1a;
            }
            QHeaderView::section {
                background-color: #f8f9fa;
                color: #495057;
                padding: 12px 8px;
                border: none;
                border-bottom: 2px solid #dee2e6;
                font-weight: bold;
                min-height: 45px;
            }
        """)
        
        # ËÆæÁΩÆË°®Â§¥
        header = self.table_widget.horizontalHeader()
        header.setStretchLastSection(False)
        header.setSectionResizeMode(0, QHeaderView.Fixed)    # ÈÄâÊã©
        header.setSectionResizeMode(1, QHeaderView.Stretch)  # ÈÇÆÁÆ±
        header.setSectionResizeMode(2, QHeaderView.Fixed)    # Áä∂ÊÄÅ
        header.setSectionResizeMode(3, QHeaderView.Fixed)    # ÈôêÂà∂
        header.setSectionResizeMode(4, QHeaderView.Fixed)    # Ë¥¶Êà∑ËøáÊúü
        header.setSectionResizeMode(5, QHeaderView.Fixed)    # Êìç‰Ωú
        
        header.resizeSection(0, 60)   # ÈÄâÊã©
        header.resizeSection(2, 100)  # Áä∂ÊÄÅ
        header.resizeSection(3, 150)  # ÈôêÂà∂
        header.resizeSection(4, 120)  # Ë¥¶Êà∑ËøáÊúü
        header.resizeSection(5, 280)  # Êìç‰Ωú (ÂêØÂä®„ÄÅÂà∑Êñ∞„ÄÅÁºñËæë„ÄÅÂà†Èô§)
        
        # ËÆæÁΩÆÂûÇÁõ¥Ë°®Â§¥
        self.table_widget.verticalHeader().setVisible(False)
        self.table_widget.setSelectionBehavior(QTableWidget.SelectRows)
        self.table_widget.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)
        self.table_widget.setHorizontalScrollBarPolicy(Qt.ScrollBarAsNeeded)
        
        # ÂêØÁî®Ë°®Â§¥ÁÇπÂáªÊéíÂ∫è
        self.table_widget.setSortingEnabled(False)  # Á¶ÅÁî®Ëá™Âä®ÊéíÂ∫èÔºåÊàë‰ª¨ÊâãÂä®ÊéßÂà∂
        header.sectionClicked.connect(self.on_header_clicked)
        
        # ËÆæÁΩÆÈªòËÆ§ÊéíÂ∫èÊåáÁ§∫Âô®ÔºàË¥¶Êà∑ËøáÊúüÂàóÔºåÂçáÂ∫èÔºâ
        header.setSortIndicator(4, Qt.AscendingOrder)
    
    def update_select_all_header(self):
        """Âú®Ë°®Â§¥Á¨¨‰∏ÄÂàóËÆæÁΩÆÂÖ®ÈÄâÂ§çÈÄâÊ°Ü"""
        # ËÆæÁΩÆË°®Â§¥ÊñáÊú¨ÔºåÁÆÄÂçï‰ΩøÁî®ÊñáÊú¨Ê†áËØÜ
        header_labels = [
            'ÂÖ®ÈÄâ',  # ÈÄâÊã©Âàó
            _('table_email') if hasattr(_, 'table_email') else 'ÈÇÆÁÆ±',
            _('table_status') if hasattr(_, 'table_status') else 'Áä∂ÊÄÅ', 
            _('table_limit') if hasattr(_, 'table_limit') else 'ÈôêÂà∂',
            _('table_expiry') if hasattr(_, 'table_expiry') else 'Ë¥¶Êà∑ËøáÊúü',
            _('table_actions') if hasattr(_, 'table_actions') else 'Êìç‰Ωú'
        ]
        self.table_widget.setHorizontalHeaderLabels(header_labels)
    
    
    def update_table_view(self):
        """Êõ¥Êñ∞Ë°®Ê†ºËßÜÂõæÊï∞ÊçÆ"""
        if not self.account_manager:
            return
        
        accounts = self.account_manager.get_accounts_with_health_and_limits()
        
        # Â∫îÁî®ÊêúÁ¥¢ËøáÊª§
        if hasattr(self, 'search_text') and self.search_text:
            accounts = self.filter_accounts(accounts, self.search_text)
        
        # Â∫îÁî®ÊéíÂ∫è
        accounts = self.sort_accounts(accounts)
        
        self.table_widget.setRowCount(len(accounts))
        
        # Âú®Ë°®Â§¥Á¨¨‰∏ÄÂàóÊòæÁ§∫ÂÖ®ÈÄâÂ§çÈÄâÊ°Ü
        self.update_select_all_header()
        
        for row, account in enumerate(accounts):
            # ÈÄâÊã©Âàó - Â§çÈÄâÊ°Ü
            checkbox_widget = QWidget()
            checkbox_layout = QHBoxLayout()
            checkbox_layout.setContentsMargins(0, 0, 0, 0)
            checkbox_layout.setAlignment(Qt.AlignCenter)
            checkbox = QCheckBox()
            checkbox.setProperty('account_id', account.get('id'))
            # Ê∑ªÂä†Áä∂ÊÄÅÊîπÂèò‰ø°Âè∑ÔºåÁî®‰∫éÊõ¥Êñ∞ÂÖ®ÈÄâÊ°ÜÁä∂ÊÄÅ
            checkbox.stateChanged.connect(self.update_select_all_state)
            checkbox_layout.addWidget(checkbox)
            checkbox_widget.setLayout(checkbox_layout)
            self.table_widget.setCellWidget(row, 0, checkbox_widget)
            
            # ÈÇÆÁÆ±
            email_item = QTableWidgetItem(account.get('email', 'unknown'))
            email_item.setToolTip(account.get('email', 'unknown'))  # ÊòæÁ§∫ÂÆåÊï¥ÈÇÆÁÆ±
            self.table_widget.setItem(row, 1, email_item)
            
            # Áä∂ÊÄÅ
            status = self.get_account_status_text(account)
            status_item = QTableWidgetItem(status)
            status_item.setTextAlignment(Qt.AlignCenter)
            # Ê†πÊçÆÁä∂ÊÄÅËÆæÁΩÆÈ¢úËâ≤
            if account.get('is_active'):
                status_item.setForeground(QColor('#10B981'))
            elif account.get('status') == 'banned':
                status_item.setForeground(QColor('#EF4444'))
            else:
                status_item.setForeground(QColor('#F59E0B'))
            self.table_widget.setItem(row, 2, status_item)
            
            # ÈôêÂà∂ (ÊòæÁ§∫Áî®Èáè/ÈôêÂà∂)
            usage = account.get('usage', '0')
            limit = account.get('limit', '2500')
            limit_text = f"{usage}/{limit} GB"
            limit_item = QTableWidgetItem(limit_text)
            limit_item.setTextAlignment(Qt.AlignCenter)
            # Ê†πÊçÆ‰ΩøÁî®ÁéáËÆæÁΩÆÈ¢úËâ≤
            try:
                usage_percent = (float(usage) / float(limit)) * 100
                if usage_percent >= 90:
                    limit_item.setForeground(QColor('#EF4444'))  # Á∫¢Ëâ≤
                elif usage_percent >= 70:
                    limit_item.setForeground(QColor('#F59E0B'))  # Ê©ôËâ≤
                else:
                    limit_item.setForeground(QColor('#10B981'))  # ÁªøËâ≤
            except:
                pass
            self.table_widget.setItem(row, 3, limit_item)
            
            # Ë¥¶Êà∑ËøáÊúü
            expiry = self.format_account_expiry(account)
            expiry_item = QTableWidgetItem(expiry)
            expiry_item.setTextAlignment(Qt.AlignCenter)
            self.table_widget.setItem(row, 4, expiry_item)
            
            # Êìç‰ΩúÊåâÈíÆ
            action_widget = QWidget()
            action_layout = QHBoxLayout()
            action_layout.setContentsMargins(5, 2, 5, 2)
            action_layout.setSpacing(3)
            
            # ÂêØÂä®ÊåâÈíÆ
            start_btn = QPushButton("üöÄ")
            start_btn.setToolTip(_('table_action_start') if hasattr(_, 'table_action_start') else 'ÂêØÂä®')
            start_btn.setStyleSheet(theme_manager.get_table_button_style('success'))
            start_btn.clicked.connect(lambda checked, acc=account: self.start_account(acc))
            action_layout.addWidget(start_btn)
            
            # Âà∑Êñ∞ÊåâÈíÆ
            refresh_btn = QPushButton("üîÑ")
            refresh_btn.setToolTip(_('table_action_refresh') if hasattr(_, 'table_action_refresh') else 'Âà∑Êñ∞')
            refresh_btn.setStyleSheet(theme_manager.get_table_button_style('primary'))
            refresh_btn.clicked.connect(lambda checked, acc=account: self.refresh_account(acc))
            action_layout.addWidget(refresh_btn)
            
            # ÁºñËæëÊåâÈíÆ
            edit_btn = QPushButton("‚úèÔ∏è")
            edit_btn.setToolTip(_('table_action_edit') if hasattr(_, 'table_action_edit') else 'ÁºñËæë')
            edit_btn.setStyleSheet(theme_manager.get_table_button_style('warning'))
            edit_btn.clicked.connect(lambda checked, acc=account: self.edit_account(acc))
            action_layout.addWidget(edit_btn)
            
            # Âà†Èô§ÊåâÈíÆ
            delete_btn = QPushButton("üóëÔ∏è")
            delete_btn.setToolTip(_('table_action_delete') if hasattr(_, 'table_action_delete') else 'Âà†Èô§')
            delete_btn.setStyleSheet(theme_manager.get_table_button_style('danger'))
            delete_btn.clicked.connect(lambda checked, acc=account: self.delete_account(acc))
            action_layout.addWidget(delete_btn)
            
            action_widget.setLayout(action_layout)
            self.table_widget.setCellWidget(row, 5, action_widget)
    
    def get_account_status_text(self, account):
        """Ëé∑ÂèñË¥¶Êà∑Áä∂ÊÄÅÊñáÊú¨"""
        if account.get('is_active'):
            return '‚úÖ Ê¥ªË∑É'
        elif account.get('status') == 'banned':
            return '‚ùå Â∞ÅÁ¶Å'
        else:
            return '‚ö†Ô∏è Êú™Ê¥ªË∑É'
    
    def format_account_expiry(self, account):
        """Ê†ºÂºèÂåñË¥¶Êà∑ËøáÊúüÊó∂Èó¥"""
        expiry = account.get('expiry', '')
        if expiry and expiry != 'N/A':
            expiry_str = str(expiry)
            if '-' in expiry_str or '/' in expiry_str:
                return expiry_str.split(' ')[0] if ' ' in expiry_str else expiry_str
            return expiry_str
        return 'Ê∞∏‰πÖ'
    
    def start_account(self, account):
        """ÂêØÂä®Ë¥¶Êà∑ - ÂàáÊç¢Âà∞Ê≠§Ë¥¶Êà∑"""
        try:
            account_id = account.get('id')
            if self.account_manager:
                self.account_manager.switch_account(account_id)
                QMessageBox.information(self, 'ÊàêÂäü', f'Â∑≤ÂàáÊç¢Âà∞Ë¥¶Êà∑: {account.get("email")}')
                self.load_accounts()
        except Exception as e:
            QMessageBox.warning(self, 'ÈîôËØØ', f'ÂàáÊç¢Ë¥¶Êà∑Â§±Ë¥•: {str(e)}')
    
    def refresh_account(self, account):
        """Âà∑Êñ∞Ë¥¶Êà∑‰ø°ÊÅØ"""
        try:
            if self.account_manager:
                # Âà∑Êñ∞Âçï‰∏™Ë¥¶Êà∑ÁöÑÈôêÂà∂ÂíåÁä∂ÊÄÅ
                self.account_manager.refresh_account_status(account.get('id'))
                self.load_accounts()
        except Exception as e:
            QMessageBox.warning(self, 'ÈîôËØØ', f'Âà∑Êñ∞Ë¥¶Êà∑Â§±Ë¥•: {str(e)}')
    
    def edit_account(self, account):
        """ÁºñËæëË¥¶Êà∑‰ø°ÊÅØ"""
        # TODO: ÂºπÂá∫ÁºñËæëÂØπËØùÊ°Ü
        QMessageBox.information(self, 'ÊèêÁ§∫', f'ÁºñËæëÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠\nË¥¶Êà∑: {account.get("email")}')
    
    def switch_account(self, account):
        """ÂàáÊç¢Ë¥¶Êà∑ - ‰∏éstart_accountÁõ∏Âêå"""
        self.start_account(account)
    
    def toggle_select_all(self, state):
        """ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ"""
        is_checked = state == Qt.Checked
        
        # ‰∏¥Êó∂Êñ≠ÂºÄ‰ø°Âè∑ËøûÊé•ÔºåÈÅøÂÖçÂæ™ÁéØËß¶Âèë
        for row in range(self.table_widget.rowCount()):
            checkbox_widget = self.table_widget.cellWidget(row, 0)
            if checkbox_widget:
                checkbox = checkbox_widget.findChild(QCheckBox)
                if checkbox:
                    checkbox.stateChanged.disconnect()
                    checkbox.setChecked(is_checked)
                    checkbox.stateChanged.connect(self.update_select_all_state)
    
    def update_select_all_state(self):
        """Ê†πÊçÆÂçï‰∏™Â§çÈÄâÊ°ÜÁä∂ÊÄÅÊõ¥Êñ∞ÂÖ®ÈÄâÊ°ÜÁä∂ÊÄÅ"""
        if not hasattr(self, 'select_all_checkbox'):
            return
        
        checked_count = 0
        total_count = self.table_widget.rowCount()
        
        # ÁªüËÆ°ÈÄâ‰∏≠ÁöÑÊï∞Èáè
        for row in range(total_count):
            checkbox_widget = self.table_widget.cellWidget(row, 0)
            if checkbox_widget:
                checkbox = checkbox_widget.findChild(QCheckBox)
                if checkbox and checkbox.isChecked():
                    checked_count += 1
        
        # Êõ¥Êñ∞ÂÖ®ÈÄâÊ°ÜÁä∂ÊÄÅ
        self.select_all_checkbox.stateChanged.disconnect()
        if checked_count == 0:
            self.select_all_checkbox.setCheckState(Qt.Unchecked)
        elif checked_count == total_count:
            self.select_all_checkbox.setCheckState(Qt.Checked)
        else:
            self.select_all_checkbox.setCheckState(Qt.PartiallyChecked)
        self.select_all_checkbox.stateChanged.connect(self.toggle_select_all)
    
    
    def load_accounts(self):
        """Âä†ËΩΩË¥¶Êà∑ÂàóË°® - Áõ¥Êé•Êõ¥Êñ∞Ë°®Ê†º"""
        if not self.account_manager:
            return
        
        # Áõ¥Êé•Êõ¥Êñ∞Ë°®Ê†ºËßÜÂõæ
        self.update_table_view()
    
    def batch_delete(self):
        """ÊâπÈáèÂà†Èô§ÈÄâ‰∏≠ÁöÑË¥¶Êà∑"""
        selected_accounts = []
        
        # Ëé∑ÂèñÊâÄÊúâÈÄâ‰∏≠ÁöÑË¥¶Êà∑
        for row in range(self.table_widget.rowCount()):
            checkbox_widget = self.table_widget.cellWidget(row, 0)
            if checkbox_widget:
                checkbox = checkbox_widget.findChild(QCheckBox)
                if checkbox and checkbox.isChecked():
                    account_id = checkbox.property('account_id')
                    selected_accounts.append(account_id)
        
        if not selected_accounts:
            QMessageBox.warning(self, 'ÊèêÁ§∫', 'ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑË¥¶Êà∑')
            return
        
        # Á°ÆËÆ§Âà†Èô§
        reply = QMessageBox.question(
            self, 'Á°ÆËÆ§Âà†Èô§',
            f'Á°ÆÂÆöË¶ÅÂà†Èô§{len(selected_accounts)}‰∏™Ë¥¶Êà∑ÂêóÔºü',
            QMessageBox.Yes | QMessageBox.No
        )
        
        if reply == QMessageBox.Yes:
            for account_id in selected_accounts:
                try:
                    self.account_manager.delete_account(account_id)
                except Exception as e:
                    print(f'Âà†Èô§Ë¥¶Êà∑{account_id}Â§±Ë¥•: {e}')
            
            self.load_accounts()
            QMessageBox.information(self, 'ÊàêÂäü', f'Â∑≤Âà†Èô§{len(selected_accounts)}‰∏™Ë¥¶Êà∑')
    
    def add_account(self):
        """Ê∑ªÂä†Êñ∞Ë¥¶Êà∑"""
        # TODO: ÂºπÂá∫Ê∑ªÂä†Ë¥¶Êà∑ÂØπËØùÊ°Ü
        QMessageBox.information(self, 'ÊèêÁ§∫', 'Ê∑ªÂä†Ë¥¶Êà∑ÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠')
    
    def refresh_all(self):
        """Âà∑Êñ∞ÊâÄÊúâË¥¶Êà∑‰ø°ÊÅØ"""
        try:
            if self.account_manager:
                # Âà∑Êñ∞ÊâÄÊúâË¥¶Êà∑ÁöÑÈôêÂà∂ÂíåÁä∂ÊÄÅ
                accounts = self.account_manager.get_accounts_with_health_and_limits()
                for account in accounts:
                    self.account_manager.refresh_account_status(account.get('id'))
                
                self.load_accounts()
                QMessageBox.information(self, 'ÊàêÂäü', 'Â∑≤Âà∑Êñ∞ÊâÄÊúâË¥¶Êà∑‰ø°ÊÅØ')
        except Exception as e:
            QMessageBox.warning(self, 'ÈîôËØØ', f'Âà∑Êñ∞Â§±Ë¥•: {str(e)}')
    
    def delete_account(self, account):
        """Âà†Èô§Âçï‰∏™Ë¥¶Êà∑"""
        reply = QMessageBox.question(
            self, 'Á°ÆËÆ§Âà†Èô§',
            f'Á°ÆÂÆöË¶ÅÂà†Èô§Ë¥¶Êà∑ {account.get("email")} ÂêóÔºü',
            QMessageBox.Yes | QMessageBox.No
        )
        
        if reply == QMessageBox.Yes:
            try:
                if self.account_manager:
                    self.account_manager.delete_account(account.get('id'))
                    self.load_accounts()
                    QMessageBox.information(self, 'ÊàêÂäü', f'Â∑≤Âà†Èô§Ë¥¶Êà∑: {account.get("email")}')
                else:
                    QMessageBox.warning(self, 'ÈîôËØØ', 'Ë¥¶Êà∑ÁÆ°ÁêÜÂô®Êú™ÂàùÂßãÂåñ')
            except Exception as e:
                QMessageBox.warning(self, 'ÈîôËØØ', f'Âà†Èô§Â§±Ë¥•: {str(e)}')
    def refresh_ui_texts(self):
        """Âà∑Êñ∞UIÊñáÊú¨ÂΩìËØ≠Ë®ÄÂèòÂåñÊó∂"""
        # ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢‰ª•Êõ¥Êñ∞ÊâÄÊúâÊñáÊú¨
        self.load_accounts()
    
    def on_search_text_changed(self, text):
        """ÊêúÁ¥¢ÊñáÊú¨ÂèòÂåñÊó∂Ëß¶Âèë"""
        self.search_text = text.lower()
        self.update_table_view()
    
    def filter_accounts(self, accounts, search_text):
        """Ê†πÊçÆÊêúÁ¥¢ÊñáÊú¨ËøáÊª§Ë¥¶Êà∑"""
        if not search_text:
            return accounts
        
        filtered = []
        for account in accounts:
            # ÊêúÁ¥¢ÈÇÆÁÆ±„ÄÅÁî®Êà∑ID„ÄÅÁä∂ÊÄÅÁ≠â
            if (search_text in account.get('email', '').lower() or
                search_text in account.get('user_id', '').lower() or
                search_text in account.get('status', '').lower() or
                search_text in str(account.get('usage', '')).lower()):
                filtered.append(account)
        return filtered
    
    def sort_accounts(self, accounts):
        """ÂØπË¥¶Êà∑ËøõË°åÊéíÂ∫è"""
        if not hasattr(self, 'sort_column'):
            self.sort_column = 4  # ÈªòËÆ§ÊåâË¥¶Êà∑ËøáÊúüÂàóÊéíÂ∫è
            self.sort_order = Qt.AscendingOrder
        
        # ÂÆö‰πâÂêÑÂàóÁöÑÊéíÂ∫èÂáΩÊï∞
        def get_sort_key(account):
            if self.sort_column == 1:  # ÈÇÆÁÆ±Âàó
                return account.get('email', '')
            elif self.sort_column == 2:  # Áä∂ÊÄÅÂàó
                status_order = {'active': 0, 'inactive': 1, 'banned': 2, 'expired': 3}
                return status_order.get(account.get('status', 'unknown'), 4)
            elif self.sort_column == 3:  # ÈôêÂà∂ÂàóÔºà‰ΩøÁî®ÁéáÔºâ
                try:
                    usage = float(account.get('usage', '0').replace('GB', '').strip())
                    limit = float(account.get('limit', '2500').replace('GB', '').strip())
                    return (usage / limit) * 100 if limit > 0 else 0
                except:
                    return 0
            elif self.sort_column == 4:  # Ë¥¶Êà∑ËøáÊúüÂàó
                return self.get_expiry_sort_key(account)
            else:
                return 0
        
        # Ê†πÊçÆÊéíÂ∫èÈ°∫Â∫èÊéíÂ∫è
        reverse = (self.sort_order == Qt.DescendingOrder)
        return sorted(accounts, key=get_sort_key, reverse=reverse)
    
    def get_expiry_sort_key(self, account):
        """Ëé∑ÂèñËøáÊúüÊó∂Èó¥ÁöÑÊéíÂ∫èÈîÆ"""
        expiry = account.get('expiry', '')
        
        # Â§ÑÁêÜÊ∞∏‰πÖË¥¶Êà∑ÔºàÊîæÂú®ÊúÄÂêéÔºâ
        if not expiry or expiry == 'N/A' or expiry == 'Ê∞∏‰πÖ':
            return float('inf')
        
        # Â§ÑÁêÜÂ∑≤ËøáÊúüÔºàÊîæÂú®ÊúÄÂâçÔºâ
        if account.get('status') == 'expired':
            return -1
        
        # Â∞ùËØïËß£ÊûêÊó•ÊúüÂ≠óÁ¨¶‰∏≤
        expiry_str = str(expiry)
        
        # Â§ÑÁêÜ‰∏≠ÊñáÊ†ºÂºèÁöÑÂâ©‰ΩôÊó∂Èó¥
        if 'Ââ©‰Ωô' in expiry_str:
            try:
                if 'ÂàÜÈíü' in expiry_str:
                    minutes = int(expiry_str.split('Ââ©‰Ωô')[1].split('ÂàÜÈíü')[0])
                    return minutes / (24 * 60)  # ËΩ¨Êç¢‰∏∫Â§©Êï∞
                elif 'Â∞èÊó∂' in expiry_str:
                    hours = int(expiry_str.split('Ââ©‰Ωô')[1].split('Â∞èÊó∂')[0])
                    return hours / 24  # ËΩ¨Êç¢‰∏∫Â§©Êï∞
                elif 'Â§©' in expiry_str:
                    days = int(expiry_str.split('Ââ©‰Ωô')[1].split('Â§©')[0])
                    return days
            except:
                pass
        
        # Â§ÑÁêÜÊó•ÊúüÊ†ºÂºè (YYYY-MM-DD Êàñ YYYY/MM/DD)
        if '-' in expiry_str or '/' in expiry_str:
            try:
                from datetime import datetime
                # Âè™ÂèñÊó•ÊúüÈÉ®ÂàÜ
                date_str = expiry_str.split(' ')[0] if ' ' in expiry_str else expiry_str
                
                # Â∞ùËØï‰∏çÂêåÁöÑÊó•ÊúüÊ†ºÂºè
                for fmt in ['%Y-%m-%d', '%Y/%m/%d', '%d-%m-%Y', '%d/%m/%Y']:
                    try:
                        expiry_date = datetime.strptime(date_str, fmt)
                        # ËÆ°ÁÆóË∑ùÁ¶ª‰ªäÂ§©ÁöÑÂ§©Êï∞
                        days_remaining = (expiry_date - datetime.now()).days
                        return days_remaining if days_remaining >= 0 else -1
                    except:
                        continue
            except:
                pass
        
        # ÈªòËÆ§ÊîæÂú®‰∏≠Èó¥
        return 9999
    
    def import_accounts(self):
        """ÂØºÂÖ•Ë¥¶Êà∑"""
        file_path, _ = QFileDialog.getOpenFileName(
            self, 'ÂØºÂÖ•Ë¥¶Êà∑', '', 'JSON Files (*.json);;CSV Files (*.csv);;All Files (*)'
        )
        
        if file_path:
            try:
                import json
                import csv
                
                accounts_to_import = []
                
                if file_path.endswith('.json'):
                    with open(file_path, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        if isinstance(data, list):
                            accounts_to_import = data
                        elif isinstance(data, dict) and 'accounts' in data:
                            accounts_to_import = data['accounts']
                
                elif file_path.endswith('.csv'):
                    with open(file_path, 'r', encoding='utf-8') as f:
                        reader = csv.DictReader(f)
                        accounts_to_import = list(reader)
                
                # ÂØºÂÖ•Ë¥¶Êà∑
                imported_count = 0
                for account_data in accounts_to_import:
                    try:
                        if self.account_manager:
                            self.account_manager.add_account(account_data)
                            imported_count += 1
                    except Exception as e:
                        print(f'ÂØºÂÖ•Ë¥¶Êà∑Â§±Ë¥•: {e}')
                
                self.load_accounts()
                QMessageBox.information(self, 'ÊàêÂäü', f'ÊàêÂäüÂØºÂÖ• {imported_count} ‰∏™Ë¥¶Êà∑')
            
            except Exception as e:
                QMessageBox.warning(self, 'ÈîôËØØ', f'ÂØºÂÖ•Â§±Ë¥•: {str(e)}')
    
    def export_accounts(self):
        """ÂØºÂá∫Ë¥¶Êà∑"""
        file_path, _ = QFileDialog.getSaveFileName(
            self, 'ÂØºÂá∫Ë¥¶Êà∑', 'warp_accounts.json', 'JSON Files (*.json);;CSV Files (*.csv)'
        )
        
        if file_path:
            try:
                accounts = self.account_manager.get_accounts_with_health_and_limits() if self.account_manager else []
                
                if file_path.endswith('.json'):
                    import json
                    with open(file_path, 'w', encoding='utf-8') as f:
                        json.dump({'accounts': accounts}, f, ensure_ascii=False, indent=2)
                
                elif file_path.endswith('.csv'):
                    import csv
                    if accounts:
                        with open(file_path, 'w', encoding='utf-8', newline='') as f:
                            writer = csv.DictWriter(f, fieldnames=accounts[0].keys())
                            writer.writeheader()
                            writer.writerows(accounts)
                
                QMessageBox.information(self, 'ÊàêÂäü', f'ÊàêÂäüÂØºÂá∫ {len(accounts)} ‰∏™Ë¥¶Êà∑')
            
            except Exception as e:
                QMessageBox.warning(self, 'ÈîôËØØ', f'ÂØºÂá∫Â§±Ë¥•: {str(e)}')
    
    def batch_activate(self):
        """ÊâπÈáèÊøÄÊ¥ªÈÄâ‰∏≠ÁöÑË¥¶Êà∑"""
        selected_accounts = self.get_selected_accounts()
        if not selected_accounts:
            QMessageBox.warning(self, 'ÊèêÁ§∫', 'ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊøÄÊ¥ªÁöÑË¥¶Êà∑')
            return
        
        activated_count = 0
        for account_id in selected_accounts:
            try:
                if self.account_manager:
                    # ÊøÄÊ¥ªË¥¶Êà∑ÈÄªËæë
                    self.account_manager.activate_account(account_id)
                    activated_count += 1
            except Exception as e:
                print(f'ÊøÄÊ¥ªË¥¶Êà∑ {account_id} Â§±Ë¥•: {e}')
        
        self.load_accounts()
        QMessageBox.information(self, 'ÊàêÂäü', f'ÊàêÂäüÊøÄÊ¥ª {activated_count} ‰∏™Ë¥¶Êà∑')
    
    def batch_pause(self):
        """ÊâπÈáèÊöÇÂÅúÈÄâ‰∏≠ÁöÑË¥¶Êà∑"""
        selected_accounts = self.get_selected_accounts()
        if not selected_accounts:
            QMessageBox.warning(self, 'ÊèêÁ§∫', 'ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊöÇÂÅúÁöÑË¥¶Êà∑')
            return
        
        paused_count = 0
        for account_id in selected_accounts:
            try:
                if self.account_manager:
                    # ÊöÇÂÅúË¥¶Êà∑ÈÄªËæë
                    self.account_manager.pause_account(account_id)
                    paused_count += 1
            except Exception as e:
                print(f'ÊöÇÂÅúË¥¶Êà∑ {account_id} Â§±Ë¥•: {e}')
        
        self.load_accounts()
        QMessageBox.information(self, 'ÊàêÂäü', f'ÊàêÂäüÊöÇÂÅú {paused_count} ‰∏™Ë¥¶Êà∑')
    
    def batch_refresh_selected(self):
        """ÊâπÈáèÂà∑Êñ∞ÈÄâ‰∏≠ÁöÑË¥¶Êà∑"""
        selected_accounts = self.get_selected_accounts()
        if not selected_accounts:
            QMessageBox.warning(self, 'ÊèêÁ§∫', 'ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà∑Êñ∞ÁöÑË¥¶Êà∑')
            return
        
        refreshed_count = 0
        for account_id in selected_accounts:
            try:
                if self.account_manager:
                    self.account_manager.refresh_account_status(account_id)
                    refreshed_count += 1
            except Exception as e:
                print(f'Âà∑Êñ∞Ë¥¶Êà∑ {account_id} Â§±Ë¥•: {e}')
        
        self.load_accounts()
        QMessageBox.information(self, 'ÊàêÂäü', f'ÊàêÂäüÂà∑Êñ∞ {refreshed_count} ‰∏™Ë¥¶Êà∑')
    
    def copy_selected_emails(self):
        """Â§çÂà∂ÈÄâ‰∏≠Ë¥¶Êà∑ÁöÑÈÇÆÁÆ±"""
        selected_accounts = self.get_selected_accounts()
        if not selected_accounts:
            QMessageBox.warning(self, 'ÊèêÁ§∫', 'ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂ§çÂà∂ÈÇÆÁÆ±ÁöÑË¥¶Êà∑')
            return
        
        emails = []
        accounts = self.account_manager.get_accounts_with_health_and_limits() if self.account_manager else []
        
        for account in accounts:
            if account.get('id') in selected_accounts:
                emails.append(account.get('email', ''))
        
        if emails:
            from PyQt5.QtWidgets import QApplication
            clipboard = QApplication.clipboard()
            clipboard.setText('\n'.join(emails))
            QMessageBox.information(self, 'ÊàêÂäü', f'Â∑≤Â§çÂà∂ {len(emails)} ‰∏™ÈÇÆÁÆ±Âú∞ÂùÄÂà∞Ââ™Ë¥¥Êùø')
    
    def get_selected_accounts(self):
        """Ëé∑ÂèñÈÄâ‰∏≠ÁöÑË¥¶Êà∑IDÂàóË°®"""
        selected = []
        for row in range(self.table_widget.rowCount()):
            checkbox_widget = self.table_widget.cellWidget(row, 0)
            if checkbox_widget:
                checkbox = checkbox_widget.findChild(QCheckBox)
                if checkbox and checkbox.isChecked():
                    account_id = checkbox.property('account_id')
                    if account_id:
                        selected.append(account_id)
        return selected
    
    def show_advanced_filter(self):
        """ÊòæÁ§∫È´òÁ∫ßÁ≠õÈÄâÂØπËØùÊ°Ü"""
        dialog = AdvancedFilterDialog(self)
        if dialog.exec_():
            # Â∫îÁî®Á≠õÈÄâÊù°‰ª∂
            self.apply_advanced_filter(dialog.get_filter_criteria())
    
    def apply_advanced_filter(self, criteria):
        """Â∫îÁî®È´òÁ∫ßÁ≠õÈÄâÊù°‰ª∂"""
        # TODO: ÂÆûÁé∞È´òÁ∫ßÁ≠õÈÄâÈÄªËæë
        self.update_table_view()
    
    def on_header_clicked(self, logical_index):
        """Â§ÑÁêÜË°®Â§¥ÁÇπÂáª‰∫ã‰ª∂ËøõË°åÊéíÂ∫è"""
        # ‰∏çÂØπÈÄâÊã©ÂàóÔºàÁ¨¨0ÂàóÔºâÂíåÊìç‰ΩúÂàóÔºàÁ¨¨5ÂàóÔºâËøõË°åÊéíÂ∫è
        if logical_index == 0 or logical_index == 5:
            return
        
        # Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂêå‰∏ÄÂàóÔºåÂàáÊç¢ÊéíÂ∫èÈ°∫Â∫è
        if self.sort_column == logical_index:
            self.sort_order = Qt.DescendingOrder if self.sort_order == Qt.AscendingOrder else Qt.AscendingOrder
        else:
            # Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊñ∞ÂàóÔºåËÆæÁΩÆ‰∏∫ËØ•ÂàóÂπ∂‰ΩøÁî®ÈªòËÆ§ÊéíÂ∫èÈ°∫Â∫è
            self.sort_column = logical_index
            # Ë¥¶Êà∑ËøáÊúüÂàóÈªòËÆ§ÂçáÂ∫èÔºàÊúÄÂø´ËøáÊúüÁöÑÂú®ÂâçÔºâÔºåÂÖ∂‰ªñÂàóÈªòËÆ§ÂçáÂ∫è
            self.sort_order = Qt.AscendingOrder
        
        # Êõ¥Êñ∞Ë°®Â§¥ÊòæÁ§∫ÊéíÂ∫èÊåáÁ§∫Âô®
        header = self.table_widget.horizontalHeader()
        header.setSortIndicator(logical_index, self.sort_order)
        
        # Âà∑Êñ∞Ë°®Ê†ºÊòæÁ§∫
        self.update_table_view()


class AdvancedFilterDialog(QDialog):
    """È´òÁ∫ßÁ≠õÈÄâÂØπËØùÊ°Ü"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle('È´òÁ∫ßÁ≠õÈÄâ')
        self.setModal(True)
        self.setMinimumWidth(400)
        self.init_ui()
    
    def init_ui(self):
        layout = QVBoxLayout()
        
        # ÂàõÂª∫Ë°®ÂçïÂ∏ÉÂ±Ä
        form_layout = QFormLayout()
        
        # Áä∂ÊÄÅÁ≠õÈÄâ
        self.status_combo = QComboBox()
        self.status_combo.addItems(['ÂÖ®ÈÉ®', 'Ê¥ªË∑É', 'Êú™Ê¥ªË∑É', 'Â∑≤Â∞ÅÁ¶Å', 'Â∑≤ËøáÊúü'])
        form_layout.addRow('Áä∂ÊÄÅ:', self.status_combo)
        
        # ‰ΩøÁî®ÁéáÁ≠õÈÄâ
        usage_layout = QHBoxLayout()
        self.usage_min = QSpinBox()
        self.usage_min.setRange(0, 100)
        self.usage_min.setSuffix('%')
        usage_layout.addWidget(self.usage_min)
        usage_layout.addWidget(QLabel('Ëá≥'))
        self.usage_max = QSpinBox()
        self.usage_max.setRange(0, 100)
        self.usage_max.setValue(100)
        self.usage_max.setSuffix('%')
        usage_layout.addWidget(self.usage_max)
        form_layout.addRow('‰ΩøÁî®Áéá:', usage_layout)
        
        # ËøáÊúüÊó∂Èó¥Á≠õÈÄâ
        self.expiry_combo = QComboBox()
        self.expiry_combo.addItems([
            'ÂÖ®ÈÉ®', 'Ê∞∏‰πÖ', '7Â§©ÂÜÖËøáÊúü', '30Â§©ÂÜÖËøáÊúü', 'Â∑≤ËøáÊúü'
        ])
        form_layout.addRow('ËøáÊúüÊó∂Èó¥:', self.expiry_combo)
        
        layout.addLayout(form_layout)
        
        # ÊåâÈíÆ
        buttons = QDialogButtonBox(
            QDialogButtonBox.Ok | QDialogButtonBox.Cancel,
            Qt.Horizontal, self
        )
        buttons.accepted.connect(self.accept)
        buttons.cancelled.connect(self.reject)
        layout.addWidget(buttons)
        
        self.setLayout(layout)
    
    def get_filter_criteria(self):
        """Ëé∑ÂèñÁ≠õÈÄâÊù°‰ª∂"""
        return {
            'status': self.status_combo.currentText(),
            'usage_min': self.usage_min.value(),
            'usage_max': self.usage_max.value(),
            'expiry': self.expiry_combo.currentText()
        }
